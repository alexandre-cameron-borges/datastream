FROM apache/airflow:2.9.1

# Mettre à jour pip pour réduire le backtracking
RUN python -m pip install --upgrade pip

# Copier et installer les dépendances de base
COPY requirements.txt /requirements.txt

# Installation en deux étapes pour réduire les conflits
RUN python -m pip install --no-cache-dir \
        kafka-python==2.0.2 \
        elasticsearch==8.13.1 \
        google-cloud-storage==2.16.0 \
    && python -m pip install --no-cache-dir \
        "apache-airflow-providers-elasticsearch>=6.0.0" \
        apache-airflow-providers-google==10.15.0

# Copier les DAGs
COPY dags/ /opt/airflow/dags/

# Clé SA (DEV uniquement) : copie seulement si présente
# Vérifie que le fichier existe avant de copier pour éviter les erreurs
COPY keys/gcp-sa.json /opt/airflow/keys/gcp-sa.json
ENV GOOGLE_APPLICATION_CREDENTIALS=/opt/airflow/keys/gcp-sa.json
